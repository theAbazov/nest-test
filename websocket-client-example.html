<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Client Example - Todo App</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        margin: 5px;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button.success {
        background: #28a745;
      }
      button.success:hover {
        background: #218838;
      }
      input,
      textarea,
      select {
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 100%;
        box-sizing: border-box;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
        font-family: Arial, sans-serif;
      }
      .status {
        padding: 5px;
        border-radius: 3px;
        margin: 5px 0;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .form-group {
        margin: 10px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Client Example - Todo App</h1>

    <div class="section">
      <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
      <input
        type="text"
        id="tokenInput"
        placeholder="–í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω"
        style="width: 100%"
      />
      <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
      <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω</div>
    </div>
    <div class="section">
      <h3>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π</h3>
      <button onclick="joinRoom()">Join Room</button>
      <button class="success" onclick="createTodo()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ TODO</button>

      <button onclick="simulateEventCreated()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å Created</button>
      <button onclick="simulateEventUpdated()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å Updated</button>
      <button onclick="simulateEventDeleted()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å Deleted</button>
      <button onclick="simulateEventCompleted()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å Completed</button>
    </div>

    <div class="section">
      <h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
      <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div id="log" class="log"></div>
    </div>

    <script>
      let socket = null;
      const logDiv = document.getElementById('log');
      const statusDiv = document.getElementById('status');

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(connected) {
        if (connected) {
          statusDiv.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
          statusDiv.className = 'status connected';
        } else {
          statusDiv.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
          statusDiv.className = 'status disconnected';
        }
      }

      function connect() {
        const token = document.getElementById('tokenInput').value.trim();

        if (!token) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω');
          return;
        }

        if (socket) {
          socket.disconnect();
        }

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        socket = io('http://localhost:3000', {
          auth: {
            token: token,
          },
          transports: ['websocket', 'polling'],
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        socket.on('connect', () => {
          log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
          updateStatus(true);
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          joinRoom();
        });

        socket.on('disconnect', (reason) => {
          log(`‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${reason}`);
          updateStatus(false);
        });

        socket.on('connect_error', (error) => {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
          updateStatus(false);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        socket.on('joined', (data) => {
          log(`üéâ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${JSON.stringify(data)}`);
        });

        socket.on('error', (error) => {
          log(`üö® –û—à–∏–±–∫–∞: ${JSON.stringify(error)}`);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ TODO —Å–æ–±—ã—Ç–∏–π
        socket.on('todo:created', (data) => {
          log(`üìù TODO —Å–æ–∑–¥–∞–Ω: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('todo:updated', (data) => {
          log(`‚úèÔ∏è TODO –æ–±–Ω–æ–≤–ª–µ–Ω: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('todo:deleted', (data) => {
          log(`üóëÔ∏è TODO —É–¥–∞–ª–µ–Ω: ${JSON.stringify(data)}`);
        });

        socket.on('todo:completed', (data) => {
          log(`‚úÖ TODO –∑–∞–≤–µ—Ä—à–µ–Ω: ${JSON.stringify(data, null, 2)}`);
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function joinRoom() {
        if (!socket) {
          alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É');
          return;
        }

        socket.emit('join');
        log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: join');
      }

      function simulateEventCreated() {
        log(
          'üîÆ –°–∏–º—É–ª—è—Ü–∏—è: —Å–æ–∑–¥–∞–π—Ç–µ TODO —á–µ—Ä–µ–∑ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è todo:created',
        );
      }

      function simulateEventUpdated() {
        log(
          'üîÆ –°–∏–º—É–ª—è—Ü–∏—è: –æ–±–Ω–æ–≤–∏—Ç–µ TODO —á–µ—Ä–µ–∑ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è todo:updated',
        );
      }

      function simulateEventDeleted() {
        log(
          'üîÆ –°–∏–º—É–ª—è—Ü–∏—è: —É–¥–∞–ª–∏—Ç–µ TODO —á–µ—Ä–µ–∑ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è todo:deleted',
        );
      }

      function simulateEventCompleted() {
        log(
          'üîÆ –°–∏–º—É–ª—è—Ü–∏—è: –æ—Ç–º–µ—Ç—å—Ç–µ TODO –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —á–µ—Ä–µ–∑ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è todo:completed',
        );
      }

      function clearLog() {
        logDiv.innerHTML = '';
      }

      async function createTodo() {
        // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –æ—Ç –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
        const token = document
          .getElementById('tokenInput')
          .value.trim()
          .replace(/[^\x00-\x7F]/g, '');

        if (!token) {
          alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å');
          return;
        }

        try {
          log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ TODO...');

          const headers = new Headers();
          headers.append('Content-Type', 'application/json');
          headers.append('Authorization', 'Bearer ' + token);

            const response = await fetch('http://localhost:3000/api/todos', {
              method: 'POST',
              headers: headers,
              body: JSON.stringify({
                title: '–ò–∑—É—á–∏—Ç—å NestJS',
                description: '–ü—Ä–æ–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç',
                priority: 'medium',
                dueDate: '2025-12-31T23:59:59.000Z'
              })
            });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è TODO');
          }

          const result = await response.json();
          log(
            `‚úÖ TODO —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: ${JSON.stringify(result.data, null, 2)}`,
          );
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è TODO: ${error.message}`);
          alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è TODO: ${error.message}`);
        }
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener('beforeunload', () => {
        if (socket) {
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>
